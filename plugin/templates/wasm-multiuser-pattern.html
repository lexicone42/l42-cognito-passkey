<!DOCTYPE html>
<!--
  L42 Cognito Passkey - Multi-User WASM Pattern Template

  Architecture:
  ==============
  - Real-time WebSocket connections for player synchronization
  - WASM modules for game logic / computation (client-side)
  - Role hierarchy: Player < Moderator < DM < Admin

  Roles:
  ======
  - player:    Join sessions, control own character, view game state
  - moderator: Community moderation, can mute/kick disruptive players
  - dm:        Dungeon Master - full session control, NPCs, world state
  - admin:     System-wide administration, user management

  Security Notes:
  ===============
  - Uses textContent for all user-controlled data display (XSS prevention)
  - Session tokens validated on WebSocket connection
  - DM/Admin actions require server-side role verification
  - WASM modules run client-side but state authoritative on server

  Testing:
  ========
  See /templates/wasm-multiuser-pattern.test.js for unit tests.
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-User WASM Game - L42 Template</title>

    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' https://lexicone.com 'unsafe-inline' 'wasm-unsafe-eval';
        style-src 'self' 'unsafe-inline';
        connect-src 'self'
            wss://*.lexicone.com
            https://cognito-idp.us-west-2.amazonaws.com
            https://cognito-identity.us-west-2.amazonaws.com
            https://*.amazoncognito.com;
        form-action 'self' https://*.amazoncognito.com;
    ">

    <style>
        :root {
            --bg: #0f0f1a;
            --surface: #1a1a2e;
            --primary: #6366f1;
            --secondary: #22d3ee;
            --dm: #f59e0b;
            --danger: #ef4444;
            --text: #e2e8f0;
            --muted: #64748b;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1.5rem;
            background: var(--surface);
            border-bottom: 1px solid #333;
        }
        .session-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .session-code {
            font-family: monospace;
            background: var(--bg);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }
        .player-count { color: var(--muted); font-size: 0.9rem; }

        .user-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        /* Role Badges */
        .role-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .role-player { background: var(--primary); }
        .role-moderator { background: #8b5cf6; }
        .role-dm { background: var(--dm); color: #000; }
        .role-admin { background: var(--danger); }

        /* Buttons */
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: opacity 0.2s;
        }
        .btn:hover { opacity: 0.9; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-dm { background: var(--dm); color: #000; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-outline {
            background: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
        }
        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.75rem; }

        /* Main Layout */
        .game-container {
            display: grid;
            grid-template-columns: 250px 1fr 300px;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar - Player List */
        .sidebar {
            background: var(--surface);
            border-right: 1px solid #333;
            display: flex;
            flex-direction: column;
        }
        .sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid #333;
            font-weight: 600;
        }
        .player-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }
        .player-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem;
            border-radius: 4px;
            margin-bottom: 0.25rem;
        }
        .player-item:hover { background: rgba(255,255,255,0.05); }
        .player-name {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .player-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #22c55e;
        }
        .player-status.away { background: var(--dm); }
        .player-status.offline { background: var(--muted); }
        .player-actions {
            display: none;
            gap: 0.25rem;
        }
        .player-item:hover .player-actions { display: flex; }

        /* Main Game Area */
        .game-area {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .game-canvas-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #0a0a12;
            position: relative;
        }
        .game-canvas {
            max-width: 100%;
            max-height: 100%;
        }

        /* DM Controls Overlay */
        .dm-controls {
            display: none;
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(0,0,0,0.8);
            border: 1px solid var(--dm);
            border-radius: 8px;
            padding: 1rem;
        }
        .dm-controls.visible { display: block; }
        .dm-controls h4 {
            color: var(--dm);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .dm-controls .btn { display: block; width: 100%; margin-bottom: 0.5rem; }

        /* Chat Panel */
        .chat-panel {
            background: var(--surface);
            border-left: 1px solid #333;
            display: flex;
            flex-direction: column;
        }
        .chat-header {
            padding: 1rem;
            border-bottom: 1px solid #333;
            font-weight: 600;
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        .chat-message {
            margin-bottom: 0.75rem;
        }
        .chat-message .author {
            font-weight: 600;
            font-size: 0.875rem;
        }
        .chat-message .content {
            color: var(--muted);
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
        .chat-message.dm .author { color: var(--dm); }
        .chat-message.system {
            color: var(--muted);
            font-style: italic;
            font-size: 0.8rem;
        }
        .chat-input-container {
            padding: 1rem;
            border-top: 1px solid #333;
        }
        .chat-input {
            width: 100%;
            padding: 0.75rem;
            background: var(--bg);
            border: 1px solid #333;
            border-radius: 4px;
            color: var(--text);
            font-size: 0.875rem;
        }

        /* Login/Join Modal */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal.visible { display: flex; }
        .modal-content {
            background: var(--surface);
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
        .modal h2 { margin-bottom: 0.5rem; }
        .modal p { color: var(--muted); margin-bottom: 1.5rem; }
        .form-group { margin-bottom: 1rem; text-align: left; }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--muted);
            font-size: 0.875rem;
        }
        .form-group input {
            width: 100%;
            padding: 0.75rem;
            background: var(--bg);
            border: 1px solid #333;
            border-radius: 4px;
            color: var(--text);
        }
        .modal-actions { display: flex; gap: 1rem; margin-top: 1.5rem; }
        .modal-actions .btn { flex: 1; }

        /* Hidden by default, shown based on role */
        .dm-only, .mod-only, .admin-only { display: none; }
        .is-dm .dm-only { display: block; }
        .is-mod .mod-only { display: block; }
        .is-admin .admin-only { display: block; }
    </style>
</head>
<body>
    <header>
        <div class="session-info">
            <strong>ðŸŽ² Game Session</strong>
            <span class="session-code" id="session-code">------</span>
            <span class="player-count" id="player-count">0 players</span>
        </div>
        <div class="user-controls">
            <span id="user-display"></span>
            <span class="role-badge" id="user-role-badge" style="display: none;"></span>
            <button class="btn btn-primary" id="btn-join">Join Session</button>
            <button class="btn btn-outline" id="btn-leave" style="display: none;">Leave</button>
        </div>
    </header>

    <div class="game-container">
        <!-- Player Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">ðŸ‘¥ Players</div>
            <div class="player-list" id="player-list">
                <!-- Players populated dynamically -->
            </div>
        </aside>

        <!-- Main Game Area -->
        <main class="game-area">
            <div class="game-canvas-container">
                <canvas id="game-canvas" class="game-canvas" width="800" height="600">
                    Your browser doesn't support canvas
                </canvas>

                <!-- DM Controls Overlay -->
                <div class="dm-controls" id="dm-controls">
                    <h4>ðŸŽ­ DM Controls</h4>
                    <button class="btn btn-dm" id="btn-spawn-npc">Spawn NPC</button>
                    <button class="btn btn-dm" id="btn-reveal-area">Reveal Area</button>
                    <button class="btn btn-dm" id="btn-pause-session">Pause Session</button>
                    <button class="btn btn-danger" id="btn-end-session">End Session</button>
                </div>
            </div>
        </main>

        <!-- Chat Panel -->
        <aside class="chat-panel">
            <div class="chat-header">ðŸ’¬ Chat</div>
            <div class="chat-messages" id="chat-messages">
                <!-- Messages populated dynamically -->
            </div>
            <div class="chat-input-container">
                <input
                    type="text"
                    class="chat-input"
                    id="chat-input"
                    placeholder="Type a message..."
                    disabled
                >
            </div>
        </aside>
    </div>

    <!-- Join/Login Modal -->
    <div class="modal visible" id="join-modal">
        <div class="modal-content">
            <h2>ðŸŽ® Join Game</h2>
            <p>Enter a session code or create a new session</p>

            <form id="join-form">
                <input type="email" id="username-hidden" autocomplete="username" style="display:none;">

                <div class="form-group">
                    <label for="session-input">Session Code</label>
                    <input
                        type="text"
                        id="session-input"
                        placeholder="ABC123"
                        maxlength="6"
                        style="text-transform: uppercase; text-align: center; font-size: 1.5rem; letter-spacing: 0.5rem;"
                    >
                </div>

                <div class="form-group" id="auth-group" style="display: none;">
                    <label for="email">Email</label>
                    <input type="email" id="email" autocomplete="email" placeholder="your@email.com">
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-outline" id="btn-create-session">Create New</button>
                    <button type="submit" class="btn btn-primary">Join</button>
                </div>
            </form>

            <p style="margin-top: 1rem; font-size: 0.8rem;">
                <span id="auth-status">Not logged in - </span>
                <a href="#" id="btn-login" style="color: var(--secondary);">Login for full features</a>
            </p>
        </div>
    </div>

    <script type="module">
        /**
         * L42 Cognito Passkey - Multi-User WASM Pattern
         *
         * This script demonstrates real-time multi-user authentication
         * with role-based access for gaming/collaborative applications.
         *
         * Role Hierarchy:
         * - player: Basic participant
         * - moderator: Can mute/kick players
         * - dm: Dungeon Master - full session control
         * - admin: System administration
         *
         * @module wasm-multiuser-auth
         */

        // =====================================================================
        // AUTH CONFIGURATION
        // =====================================================================

        const AUTH_URL = window.location.hostname === 'localhost'
            ? '/auth/auth.js'
            : 'https://lexicone.com/auth/auth.js';

        const auth = await import(AUTH_URL);

        // =====================================================================
        // ROLE DEFINITIONS
        // =====================================================================

        /**
         * Role hierarchy levels (higher = more permissions)
         * @constant {Object.<string, number>}
         */
        const ROLE_LEVELS = {
            player: 10,
            moderator: 30,
            dm: 50,
            admin: 100
        };

        /**
         * Role display configuration
         * @constant {Object.<string, {icon: string, class: string}>}
         */
        const ROLE_CONFIG = {
            player: { icon: 'ðŸŽ®', class: 'role-player' },
            moderator: { icon: 'ðŸ›¡ï¸', class: 'role-moderator' },
            dm: { icon: 'ðŸŽ­', class: 'role-dm' },
            admin: { icon: 'âš¡', class: 'role-admin' }
        };

        // =====================================================================
        // STATE
        // =====================================================================

        let currentSession = null;
        let currentRole = 'player';
        let players = [];
        let ws = null;

        // =====================================================================
        // DOM ELEMENTS
        // =====================================================================

        const $ = (sel) => document.querySelector(sel);
        const $$ = (sel) => document.querySelectorAll(sel);

        const joinModal = $('#join-modal');
        const joinForm = $('#join-form');
        const sessionInput = $('#session-input');
        const sessionCode = $('#session-code');
        const playerCount = $('#player-count');
        const playerList = $('#player-list');
        const chatMessages = $('#chat-messages');
        const chatInput = $('#chat-input');
        const dmControls = $('#dm-controls');
        const userDisplay = $('#user-display');
        const userRoleBadge = $('#user-role-badge');
        const btnJoin = $('#btn-join');
        const btnLeave = $('#btn-leave');
        const authStatus = $('#auth-status');

        // =====================================================================
        // ROLE HELPERS
        // =====================================================================

        /**
         * Get user's highest role from Cognito groups.
         * @returns {string} Role name
         */
        function getUserRole() {
            const groups = auth.getUserGroups() || [];

            // Check roles in descending privilege order
            if (groups.includes('admin') || groups.includes('dms')) return 'admin';
            if (groups.includes('dm') || groups.includes('dms')) return 'dm';
            if (groups.includes('moderator') || groups.includes('moderators')) return 'moderator';
            return 'player';
        }

        /**
         * Check if current user has at least the specified role level.
         * @param {string} requiredRole - Minimum required role
         * @returns {boolean}
         */
        function hasRoleLevel(requiredRole) {
            const userLevel = ROLE_LEVELS[currentRole] || 0;
            const requiredLevel = ROLE_LEVELS[requiredRole] || 0;
            return userLevel >= requiredLevel;
        }

        /**
         * Check specific permissions based on role.
         * @param {string} permission - Permission to check
         * @returns {boolean}
         */
        function hasPermission(permission) {
            const permissions = {
                player: ['chat', 'move-character', 'view-map'],
                moderator: ['chat', 'move-character', 'view-map', 'mute-player', 'kick-player'],
                dm: ['chat', 'move-character', 'view-map', 'mute-player', 'kick-player',
                     'spawn-npc', 'reveal-area', 'pause-session', 'end-session'],
                admin: ['*']  // All permissions
            };

            const rolePerms = permissions[currentRole] || [];
            return rolePerms.includes('*') || rolePerms.includes(permission);
        }

        // =====================================================================
        // UI UPDATES (XSS-SAFE)
        // =====================================================================

        /**
         * Update UI based on auth and session state.
         * Uses textContent for safe DOM updates.
         */
        function updateUI() {
            const authenticated = auth.isAuthenticated();
            currentRole = authenticated ? getUserRole() : 'player';

            // Update body classes for CSS-based role visibility
            document.body.classList.toggle('is-dm', currentRole === 'dm' || currentRole === 'admin');
            document.body.classList.toggle('is-mod', hasRoleLevel('moderator'));
            document.body.classList.toggle('is-admin', currentRole === 'admin');

            // User display (textContent for safety)
            if (authenticated) {
                userDisplay.textContent = auth.getUserEmail() || 'Anonymous';
                const config = ROLE_CONFIG[currentRole];
                userRoleBadge.textContent = `${config.icon} ${currentRole}`;
                userRoleBadge.className = `role-badge ${config.class}`;
                userRoleBadge.style.display = 'inline-flex';
                authStatus.textContent = 'Logged in - ';
            } else {
                userDisplay.textContent = '';
                userRoleBadge.style.display = 'none';
                authStatus.textContent = 'Not logged in - ';
            }

            // Session state
            if (currentSession) {
                joinModal.classList.remove('visible');
                sessionCode.textContent = currentSession.toUpperCase();
                chatInput.disabled = false;
                btnJoin.style.display = 'none';
                btnLeave.style.display = 'inline-block';
            } else {
                joinModal.classList.add('visible');
                sessionCode.textContent = '------';
                chatInput.disabled = true;
                btnJoin.style.display = 'inline-block';
                btnLeave.style.display = 'none';
            }

            // DM controls visibility
            dmControls.classList.toggle('visible', hasRoleLevel('dm') && currentSession);
        }

        /**
         * Render player list with safe DOM manipulation.
         * @param {Array} playerData - Array of player objects
         */
        function renderPlayerList(playerData) {
            playerList.textContent = '';  // Clear safely

            playerData.forEach(player => {
                const item = document.createElement('div');
                item.className = 'player-item';

                // Player name section
                const nameSection = document.createElement('div');
                nameSection.className = 'player-name';

                const status = document.createElement('span');
                status.className = `player-status ${player.status || 'online'}`;

                const name = document.createElement('span');
                name.textContent = player.name;  // Safe: textContent

                const badge = document.createElement('span');
                badge.className = `role-badge ${ROLE_CONFIG[player.role]?.class || 'role-player'}`;
                badge.textContent = player.role;
                badge.style.fontSize = '0.65rem';
                badge.style.padding = '0.125rem 0.25rem';

                nameSection.appendChild(status);
                nameSection.appendChild(name);
                nameSection.appendChild(badge);

                // Moderator/DM actions
                const actions = document.createElement('div');
                actions.className = 'player-actions';

                if (hasRoleLevel('moderator') && player.role === 'player') {
                    const muteBtn = document.createElement('button');
                    muteBtn.className = 'btn btn-sm btn-outline';
                    muteBtn.textContent = 'ðŸ”‡';
                    muteBtn.title = 'Mute player';
                    muteBtn.addEventListener('click', () => mutePlayer(player.id));
                    actions.appendChild(muteBtn);
                }

                if (hasRoleLevel('dm') && player.role !== 'admin') {
                    const kickBtn = document.createElement('button');
                    kickBtn.className = 'btn btn-sm btn-danger';
                    kickBtn.textContent = 'ðŸ‘¢';
                    kickBtn.title = 'Kick player';
                    kickBtn.addEventListener('click', () => kickPlayer(player.id));
                    actions.appendChild(kickBtn);
                }

                item.appendChild(nameSection);
                item.appendChild(actions);
                playerList.appendChild(item);
            });

            playerCount.textContent = `${playerData.length} player${playerData.length !== 1 ? 's' : ''}`;
        }

        /**
         * Add a chat message with safe DOM manipulation.
         * @param {Object} message - Message object
         * @param {string} message.author - Author name
         * @param {string} message.content - Message content
         * @param {string} [message.type] - Message type (dm, system)
         */
        function addChatMessage({ author, content, type = 'player' }) {
            const msg = document.createElement('div');
            msg.className = `chat-message ${type}`;

            if (type === 'system') {
                msg.textContent = content;  // Safe: textContent
            } else {
                const authorEl = document.createElement('div');
                authorEl.className = 'author';
                authorEl.textContent = author;  // Safe: textContent

                const contentEl = document.createElement('div');
                contentEl.className = 'content';
                contentEl.textContent = content;  // Safe: textContent

                msg.appendChild(authorEl);
                msg.appendChild(contentEl);
            }

            chatMessages.appendChild(msg);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // =====================================================================
        // SESSION MANAGEMENT
        // =====================================================================

        /**
         * Generate a random session code.
         * @returns {string} 6-character uppercase code
         */
        function generateSessionCode() {
            const chars = 'ABCDEFGHJKMNPQRSTUVWXYZ23456789';  // Avoid confusing chars (0, O, 1, I, L)
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        /**
         * Join a session.
         * @param {string} code - Session code
         */
        async function joinSession(code) {
            // Ensure valid tokens for WebSocket auth
            const tokens = await auth.ensureValidTokens();

            currentSession = code.toUpperCase();

            // In real implementation, connect WebSocket here
            // ws = new WebSocket(`wss://game.lexicone.com/session/${code}?token=${tokens?.access_token}`);

            // Demo: simulate joining
            players = [
                { id: '1', name: auth.getUserEmail() || 'You', role: currentRole, status: 'online' }
            ];

            renderPlayerList(players);
            addChatMessage({ content: `Joined session ${currentSession}`, type: 'system' });
            updateUI();
        }

        /**
         * Leave current session.
         */
        function leaveSession() {
            if (ws) {
                ws.close();
                ws = null;
            }
            currentSession = null;
            players = [];
            renderPlayerList([]);
            chatMessages.textContent = '';
            updateUI();
        }

        /**
         * Create a new session (DM only).
         */
        async function createSession() {
            const code = generateSessionCode();
            await joinSession(code);
            addChatMessage({ content: 'Session created! Share the code with players.', type: 'system' });
        }

        // =====================================================================
        // MODERATION ACTIONS
        // =====================================================================

        /**
         * Mute a player (moderator+).
         * @param {string} playerId - Player ID to mute
         */
        function mutePlayer(playerId) {
            if (!hasPermission('mute-player')) {
                alert('Permission denied');
                return;
            }
            console.log(`[Mod] Muting player ${playerId}`);
            addChatMessage({ content: `Player was muted`, type: 'system' });
        }

        /**
         * Kick a player from session (DM+).
         * @param {string} playerId - Player ID to kick
         */
        function kickPlayer(playerId) {
            if (!hasPermission('kick-player')) {
                alert('Permission denied');
                return;
            }
            console.log(`[DM] Kicking player ${playerId}`);
            addChatMessage({ content: `Player was removed from session`, type: 'system' });
        }

        // =====================================================================
        // DM ACTIONS
        // =====================================================================

        $('#btn-spawn-npc')?.addEventListener('click', () => {
            if (!hasPermission('spawn-npc')) return;
            console.log('[DM] Spawning NPC...');
            addChatMessage({ author: 'DM', content: 'A mysterious figure appears...', type: 'dm' });
        });

        $('#btn-reveal-area')?.addEventListener('click', () => {
            if (!hasPermission('reveal-area')) return;
            console.log('[DM] Revealing map area...');
            addChatMessage({ content: 'New area revealed on the map', type: 'system' });
        });

        $('#btn-pause-session')?.addEventListener('click', () => {
            if (!hasPermission('pause-session')) return;
            console.log('[DM] Session paused');
            addChatMessage({ content: 'Session paused by DM', type: 'system' });
        });

        $('#btn-end-session')?.addEventListener('click', () => {
            if (!hasPermission('end-session')) return;
            if (confirm('End this session for all players?')) {
                addChatMessage({ content: 'Session ended by DM', type: 'system' });
                setTimeout(leaveSession, 1000);
            }
        });

        // =====================================================================
        // EVENT HANDLERS
        // =====================================================================

        // Auth state changes
        auth.onAuthStateChange((authenticated) => {
            console.log('[Auth] State changed:', authenticated);
            updateUI();
        });

        // Join form
        joinForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const code = sessionInput.value.trim();
            if (code.length >= 4) {
                await joinSession(code);
            } else {
                alert('Please enter a valid session code');
            }
        });

        // Create session
        $('#btn-create-session')?.addEventListener('click', createSession);

        // Leave session
        btnLeave.addEventListener('click', leaveSession);

        // Show join modal
        btnJoin.addEventListener('click', () => {
            joinModal.classList.add('visible');
        });

        // Login link
        $('#btn-login')?.addEventListener('click', (e) => {
            e.preventDefault();
            auth.loginWithHostedUI();
        });

        // Chat input
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && chatInput.value.trim()) {
                const content = chatInput.value.trim();
                const author = auth.getUserEmail() || 'Anonymous';
                addChatMessage({ author, content, type: currentRole === 'dm' ? 'dm' : 'player' });
                chatInput.value = '';
            }
        });

        // =====================================================================
        // INITIALIZATION
        // =====================================================================

        updateUI();

        // Handle OAuth callback
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('code')) {
            try {
                await auth.exchangeCodeForTokens();
                window.history.replaceState({}, '', window.location.pathname);
            } catch (err) {
                console.error('OAuth callback failed:', err);
            }
        }
    </script>
</body>
</html>
