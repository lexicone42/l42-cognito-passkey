# v1.0 Readiness Scout Report

**Date**: 2026-02-19
**Scope**: Sharp-edges, property tests, Trail of Bits skills, API surface stability
**Version analyzed**: 0.18.0 (main branch, 9b288a6) — findings addressed in v0.19.0

---

## Executive Summary

The library is **production-ready** for 1.0 with **4 blocking items** and **~8 important items**. The biggest gaps are: stale TypeScript definitions, a timing side-channel in AAGUID comparison, missing PKCE property tests, and the well-known S1 (caller-controlled resource.owner) that needs clear documentation.

**Test counts**: 696 vitest + 142 pytest + 113 cargo = 951 total tests
**Property tests**: 68 (22 RBAC + 41 auth + 5 Cedar)
**Sharp-edges findings**: 15 (1 HIGH, 7 MEDIUM, 7 LOW)

---

## Part 1: Sharp-Edges Analysis (Fresh)

### HIGH Severity

| # | Finding | Status |
|---|---------|--------|
| S1 | **Resource.owner is caller-controlled** — client can lie about ownership in `requireServerAuthorization()`. Cedar forbid policy trusts client-supplied `resource.owner`. | Known since v0.13.0. Property tests document it. **Pre-1.0 action**: Document clearly that EntityProvider is required for production ownership enforcement. |

### MEDIUM Severity

| # | Finding | Pre-1.0? |
|---|---------|----------|
| S2 | **validateTokenClaims skips checks when claims fields missing** — missing `aud`/`client_id` passes validation | Fix: require at least one audience claim |
| S3 | **validateTokenClaims doesn't check expiry** — inconsistency with `isTokenExpired()` existing separately | Fix: add expiry check |
| S5 | **Context from request body passed unvalidated to Cedar** — schema currently has no context attributes, but future policies could rely on untrusted context | Document: server should build context, not forward client input |
| S9 | **Refresh token not rotated** — Rust backend doesn't store new refresh_token from Cognito response | Fix in Rust `refresh.rs` |
| S10 | **validateCredential doesn't validate clientDataJSON** — only parses attestation_object, ignores origin/challenge in clientDataJSON | Fix: parse and validate origin |
| S11 | **Sessions not invalidated on password change** — Cognito refresh_tokens survive password changes | Document as AWS Cognito limitation |
| S15 | **Admin forbid override not documented** — `:own` actions deny even admins; admins must use `:all` actions | Document in CLAUDE.md and Cedar guide |

### LOW Severity

| # | Finding | Notes |
|---|---------|-------|
| S6 | PKCE verifier in localStorage (unencrypted) | Mitigated by single-use + immediate cleanup |
| S7 | OAuth state in localStorage (survives reload) | Required for Safari ITP compatibility |
| S8 | CSRF only on state-changing endpoints | Correct by design; callback protected by OAuth state |
| S12 | No certificate pinning | Defense-in-depth, post-1.0 |
| S13 | Cognito domain not HTTPS-validated | Mitigated by URL construction prepending `https://` |
| S14 | expires_in not used for cache TTL | Performance optimization, not security |
| **NEW** | **SESSION_SECRET default not enforced** — Rust backend logs warning but uses `"change-me-in-production"` if unset | Fix: make required or fail startup |

### New Finding: Timing Side-Channel in AAGUID Comparison

**File**: `rust/src/credential.rs:check_aaguid_allowed()` (line 117)

```rust
if allowlist.iter().any(|a| a == &lower) {  // NOT constant-time
```

String equality comparison leaks information about matching AAGUID prefixes via timing. An attacker probing the `/auth/validate-credential` endpoint could narrow down which AAGUIDs are in the allowlist.

**Severity**: MEDIUM (requires network-level timing precision)
**Fix**: Use `subtle::ConstantTimeEq` or iterate all entries unconditionally.

---

## Part 2: Property Test Coverage Gaps

### Tier 1 — Must-Have (Blocking v1.0)

**1. PKCE Flow Invariants** (HIGH gap)
- No property tests for code verifier format (43-128 chars, unreserved chars only)
- No tests for challenge = base64url(SHA256(verifier)) determinism
- No tests for verifier entropy (uniqueness across calls)
- **Why it matters**: PKCE bypass allows authorization code interception

**2. Credential Validation Gate** (HIGH gap)
- `_validateCredential()` has zero property-based coverage
- AAGUID allowlist enforcement not property-tested
- Device-bound policy enforcement not property-tested
- **Why it matters**: This is a v0.19.0 security feature with no invariant tests

### Tier 2 — Should-Have (High Quality)

| Gap | Category | Tests Needed |
|-----|----------|-------------|
| Token claims: missing `sub`, negative `exp`, `exp < iat` | Token validation | 3 properties |
| Handler mode cache: TTL enforcement, concurrent dedup, 401 clears cache | Session management | 3 properties |
| Cedar forbid composition: forbid wins across all action/owner combos | Authorization | 1 property |
| Alias collision detection: no two COGNITO_GROUPS share aliases | RBAC | 1 property |
| Permission inheritance: managing role implies superset permissions | RBAC | 1 property |

### Tier 3 — Nice-to-Have

| Gap | Category |
|-----|----------|
| WebAuthn flag parsing determinism + signCount extraction | WebAuthn |
| Session persistence idempotence + race conditions | Session |
| Rate limit reset after success + exponential backoff formula | Rate limiting |
| Auto-refresh + manual refresh deduplication | Token refresh |
| JWT decode error handling (malformed base64, invalid JSON) | JWT |

---

## Part 3: Trail of Bits Skills Relevance

### Pre-1.0 (Do Now)

| Skill | Priority | Effort | What It Finds |
|-------|----------|--------|---------------|
| **constant-time-analysis** | HIGH | 0.5 days | AAGUID timing side-channel in `credential.rs` |
| **sharp-edges** (refresh) | HIGH | 1-2 days | Already done above — 15 findings |
| **property-based-testing** | HIGH | 2-3 days | PKCE + credential gate + token claims gaps |
| **variant-analysis** | MEDIUM | 1 day | Cross-route consistency in Rust backend (CSRF, errors, logging) |

### Post-1.0

| Skill | Priority | What It Finds |
|-------|----------|---------------|
| **semgrep-rule-creator** | MEDIUM | 4-5 custom rules: client-side auth checks, unsafe JWT ops, hardcoded secrets |
| **CodeQL** | MEDIUM | Token leak to logs, dead auth checks, data flow issues |
| **cargo-fuzz** | LOW | CBOR parsing crashes, JWT parsing OOB, base64 panics |
| **wycheproof** | LOW | HMAC-SHA256 edge cases (small crypto surface) |

### Not Relevant

| Skill | Why |
|-------|-----|
| yara-authoring | Not a binary/malware detection project |
| atheris/libfuzzer/aflpp | C/C++ focused; Rust has cargo-fuzz |
| insecure-defaults | Already excellent — all defaults are secure |

---

## Part 4: API Surface Stability

### Blocking for 1.0

**1. TypeScript definitions are stale (CRITICAL)**
- `auth.d.ts` says version 0.12.2, code is 0.18.0
- Still lists `tokenStorage?: 'localStorage' | 'memory' | 'handler'` (removed in v0.15.0)
- `requireServerAuthorization` default endpoint says `/api/authorize` (should be `/auth/authorize`)
- Missing: `validateCredentialEndpoint`, `sessionEndpoint`, `authenticatorMetadata`
- **Action**: Regenerate auth.d.ts from current source

**2. `sessionEndpoint` should be required**
- Currently optional but needed for passkey/password session persistence
- Without it, direct login sessions don't survive page reload
- **Action**: Make required in `configure()` or add a prominent warning

### Review Before 1.0

| Item | Recommendation |
|------|---------------|
| `getTokens()` return type | Always returns Promise in handler-only mode — commit to async API |
| `onAuthStateChange()` | Consider deprecating in favor of explicit `onLogin()` + `onLogout()` |
| Handler endpoint grouping | 6 endpoint config keys scattered — consider nested `handler: { endpoints: {...} }` |
| Cedar policy versioning | Document that example policies are locked to v1.0 |

### Risks (May Force v2.0)

| Risk | Likelihood | Mitigation |
|------|-----------|------------|
| 30-day token expiry limit hardcoded | LOW | Make configurable or document constraint |
| localStorage for OAuth state/PKCE | LOW | Required for Safari ITP — document as locked |
| Cognito group aliases hardcoded | MEDIUM | Document that custom groups need `isInCognitoGroup()` |
| RBAC 8 standard roles frozen | LOW | Additions OK, removals = v2.0 |

### API Summary

- **42 exported functions + 1 constant** across 11 functional areas
- **18 config options** (3 required, 3 handler-required, 12 optional with sensible defaults)
- **Naming**: Consistent (`loginWith*`, `UNSAFE_*`, `UI_ONLY_*` prefixes are excellent)
- **Stability score**: 8/10 — ready after fixing TypeScript defs

---

## Combined Action Plan

### BLOCKING (Must fix before 1.0 tag)

1. **Update auth.d.ts** to match v0.18.0 API surface
2. **Fix timing side-channel** in `rust/src/credential.rs:check_aaguid_allowed()`
3. **Add PKCE property tests** (code verifier format, challenge determinism, entropy)
4. **Document S1 (resource.owner)** clearly — EntityProvider required for production ownership

### IMPORTANT (Should fix before 1.0)

5. **Fix validateTokenClaims** — require audience claims, add expiry check
6. **Make SESSION_SECRET required** in Rust backend config
7. **Add credential validation gate property tests** (AAGUID + device-bound)
8. **Fix refresh token rotation** in Rust backend
9. **Validate clientDataJSON** in `/auth/validate-credential`
10. **Make sessionEndpoint required** (or add prominent warning)
11. **Document admin forbid override** (`:own` vs `:all` actions)
12. **Variant analysis pass** on Rust backend routes for consistency

### NICE-TO-HAVE (v1.0 or v1.1)

13. Add token claims edge case property tests
14. Add handler mode cache invariant tests
15. Add Cedar forbid composition property test
16. Create 4-5 Semgrep rules for integration feedback
17. Document sessions survive password change (AWS limitation)
18. Consider `onAuthStateChange()` deprecation path

### POST-1.0

19. EntityProvider implementation for trusted ownership (S1 fix)
20. FIDO MDS integration for AAGUID → authenticator name mapping
21. cargo-fuzz targets for CBOR/JWT parsing
22. CodeQL integration for CI/CD
23. Wycheproof test vectors for HMAC-SHA256

---

## Estimated Effort

| Category | Effort | Items |
|----------|--------|-------|
| Blocking fixes | 3-4 days | TypeScript defs, timing fix, PKCE tests, S1 docs |
| Important fixes | 4-5 days | Token validation, config enforcement, property tests |
| Nice-to-have | 2-3 days | Additional property tests, Semgrep, variant analysis |
| **Total pre-1.0** | **~10-12 days** | |
